<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>StreamLite — Mobile Streaming Host (Static)</title>
<meta name="description" content="Mobile-first static streaming host UI (TMDb + MerlMovie plugin support)" />
<style>
  :root{
    --bg:#0f1720; --card:#0b1220; --muted:#9aa6b2; --accent:#6ee7b7; --glass: rgba(255,255,255,0.03);
    --radius:14px; --gap:14px; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #071b28 100%);color:#e6eef6}
  /* App shell */
  .app{max-width:540px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding:16px;box-sizing:border-box}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#4fd1c5);display:flex;align-items:center;justify-content:center;font-weight:700;color:#042027;box-shadow:0 6px 18px rgba(2,8,23,0.6)}
  h1{font-size:18px;margin:0}
  .tabs{display:flex;gap:8px;margin:6px 0 12px}
  .tab{flex:1;padding:10px;border-radius:12px;background:var(--glass);text-align:center;font-weight:600;color:var(--muted);cursor:pointer}
  .tab.active{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));color:var(--accent);box-shadow:0 6px 20px rgba(3,10,20,0.6)}
  /* content */
  .content{flex:1;overflow:auto;padding-bottom:88px}
  .searchbar{display:flex;gap:8px;margin:0 0 12px}
  .searchbar input{flex:1;padding:10px;border-radius:12px;border:0;background:#07182677;color:#dfeff7;outline:none}
  .searchbar button{padding:10px 12px;border-radius:12px;border:0;background:var(--accent);color:#042027;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));border-radius:12px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column}
  .card img{width:100%;height:190px;object-fit:cover;display:block}
  .card .meta{padding:8px}
  .meta h3{margin:0;font-size:13px}
  .meta p{margin:6px 0 0;font-size:12px;color:var(--muted)}
  /* horizontal lists for favourites */
  .hscroll{display:flex;gap:10px;overflow:auto;padding:8px 0}
  .hcard{min-width:120px;border-radius:10px;background:var(--card);overflow:hidden;flex-shrink:0}
  .hcard img{height:160px;width:100%;object-fit:cover;display:block}
  .sectionTitle{display:flex;align-items:center;justify-content:space-between;margin:8px 0 6px}
  .muted{color:var(--muted);font-size:13px}
  footer{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;pointer-events:none}
  .bottomNav{width:100%;max-width:540px;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;display:flex;gap:8px;pointer-events:auto}
  .bn{flex:1;padding:8px;border-radius:10px;text-align:center;color:var(--muted);font-weight:600}
  .bn.active{color:var(--accent)}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:999}
  .modal.show{display:flex}
  .modal .panel{width:100%;max-width:720px;background:#071628;border-radius:14px;padding:12px;box-shadow:0 20px 80px rgba(2,6,23,0.8)}
  .row{display:flex;gap:8px;align-items:center}
  .chip{padding:6px 8px;border-radius:8px;background:#07182677;color:var(--muted);font-size:13px}
  .btn{padding:8px 10px;border-radius:10px;border:0;background:var(--accent);color:#042027;font-weight:700;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  /* small screens adjustments */
  @media (max-width:420px){
    .card img{height:140px}
    .hcard img{height:140px}
  }
  /* thin scrollbar */
  .content::-webkit-scrollbar,.hscroll::-webkit-scrollbar{height:8px}
  .content::-webkit-scrollbar-thumb,.hscroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}
  /* settings input */
  .settingsRow{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
  textarea.pluginInput{min-height:120px;padding:10px;border-radius:12px;border:0;background:#07182655;color:#e6eef6;resize:vertical}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="logo">SL</div>
    <div>
      <h1>StreamLite</h1>
      <div class="small">Mobile-first static host UI</div>
    </div>
  </header>

  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="movies">Movies</div>
    <div class="tab" data-tab="tv">TV Shows</div>
    <div class="tab" data-tab="favs">Favourites</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <main class="content" id="content">
    <!-- Movies / TV content containers -->
    <section id="moviesSection">
      <div class="searchbar">
        <input id="moviesSearch" placeholder="Search movies by title…" />
        <button id="moviesSearchBtn">Search</button>
      </div>
      <div class="sectionTitle"><div class="muted">Popular Movies (TMDb)</div><div class="small" id="moviesInfo"></div></div>
      <div id="moviesGrid" class="grid"></div>
    </section>

    <section id="tvSection" style="display:none">
      <div class="searchbar">
        <input id="tvSearch" placeholder="Search TV shows…" />
        <button id="tvSearchBtn">Search</button>
      </div>
      <div class="sectionTitle"><div class="muted">Popular TV Shows (TMDb)</div><div class="small" id="tvInfo"></div></div>
      <div id="tvGrid" class="grid"></div>
    </section>

    <section id="favsSection" style="display:none">
      <div class="sectionTitle"><div class="muted">Recently watched</div></div>
      <div id="recentList" class="hscroll"></div>

      <div class="sectionTitle" style="margin-top:14px"><div class="muted">Starred favourites</div><button id="clearFavs" class="btn ghost">Clear</button></div>
      <div id="favList" class="hscroll"></div>
    </section>

    <section id="settingsSection" style="display:none">
      <div class="settingsRow">
        <label class="small">TMDb API Key (required for movies & TV)</label>
        <input id="tmdbKey" placeholder="Enter your TMDb API key" />
        <div class="small">Your API key is stored locally in your browser only.</div>
      </div>

      <hr style="opacity:0.06;border:none;height:1px;margin:12px 0" />

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Plugins (MerlMovie JSON)</div>
          <div class="small muted">Format: name, image, embed_url/tv_embed_url, stream_type ("api"|"webview")</div>
        </div>

        <textarea id="pluginInput" class="pluginInput" placeholder='Paste plugin JSON here. Example: {"name":"Example","image":"https://...","embed_url":"https://...","stream_type":"api"}'></textarea>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addPlugin" class="btn">Add Plugin</button>
          <button id="encodePlugin" class="btn ghost">Encode (.merlmovieplugin)</button>
          <button id="pasteExample" class="btn ghost">Insert Example</button>
        </div>

        <div id="pluginErrors" class="small" style="margin-top:8px;color:#ffb4b4"></div>

        <div style="margin-top:12px">
          <div class="small">Installed plugins</div>
          <div id="installedPlugins" style="margin-top:8px"></div>
        </div>
      </div>

      <hr style="opacity:0.06;border:none;height:1px;margin:12px 0" />

      <div style="margin-top:8px">
        <div class="small">Storage & Debug</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportState" class="btn ghost">Export state</button>
          <button id="clearState" class="btn ghost">Clear all</button>
        </div>
        <pre id="debug" style="margin-top:8px;color:var(--muted);font-size:12px;white-space:pre-wrap"></pre>
      </div>
    </section>
  </main>

  <footer>
    <nav class="bottomNav" role="navigation" aria-label="Main">
      <div class="bn active" data-tab="movies">Movies</div>
      <div class="bn" data-tab="tv">TV</div>
      <div class="bn" data-tab="favs">Favourites</div>
      <div class="bn" data-tab="settings">Settings</div>
    </nav>
  </footer>
</div>

<!-- modal for playback / details -->
<div class="modal" id="modal">
  <div class="panel" id="modalPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div id="modalTitle" style="font-weight:700"></div>
      <div style="display:flex;gap:8px">
        <button id="starBtn" class="btn ghost">☆ Star</button>
        <button id="closeModal" class="btn">Close</button>
      </div>
    </div>
    <div id="modalBody" style="min-height:140px;"></div>
  </div>
</div>

<script>
/* StreamLite — client side only */
(()=>{

/* --- Utilities and storage --- */
const ls = {
  get(k, fallback){
    const v = localStorage.getItem(k);
    if(!v) return fallback;
    try{ return JSON.parse(v) }catch(e){ return v }
  },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)) },
  del(k){ localStorage.removeItem(k) }
};

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* Keys used */
const KEY_TM = 'tmdb_api_key';
const KEY_PLUGS = 'mm_plugins';
const KEY_RECENT = 'mm_recent';
const KEY_FAVS = 'mm_favs';

/* initial state */
let state = {
  tmdbKey: ls.get(KEY_TM, '') || '',
  plugins: ls.get(KEY_PLUGS, []) || [],
  recent: ls.get(KEY_RECENT, []) || [],
  favs: ls.get(KEY_FAVS, []) || []
};

/* MerlMovie plugin validation per docs:
   required: name, image, embed_url or tv_embed_url, stream_type
   stream_type in ["api","webview"]
   (source: MerlMovie docs) */
const pluginRequired = (p) => {
  if(!p || typeof p !== 'object') return 'JSON must be an object';
  if(!p.name) return 'Missing "name"';
  if(!p.image) return 'Missing "image"';
  if(!p.stream_type) return 'Missing "stream_type"';
  if(!['api','webview'].includes(p.stream_type)) return 'stream_type must be "api" or "webview"';
  if(!(p.embed_url || p.tv_embed_url)) return 'Either "embed_url" or "tv_embed_url" required';
  return null;
};

/* TMDb helpers (we use v3 endpoints with api_key param) */
const TM_BASE = 'https://api.themoviedb.org/3';
const TM_IMG_BASE_FALLBACK = 'https://image.tmdb.org/t/p/';
function tmImg(path, size='w342'){
  if(!path) return '';
  // build simple image URL; for best practice you can fetch /configuration but we keep it simple
  return `${TM_IMG_BASE_FALLBACK}${size}${path}`;
}

/* --- UI wiring --- */
function setActiveTab(tab){
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
  $$('.bn').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
  $('#moviesSection').style.display = tab==='movies' ? '' : 'none';
  $('#tvSection').style.display = tab==='tv' ? '' : 'none';
  $('#favsSection').style.display = tab==='favs' ? '' : 'none';
  $('#settingsSection').style.display = tab==='settings' ? '' : 'none';
}
$$('.tab').forEach(t=>t.addEventListener('click', ()=>setActiveTab(t.dataset.tab)));
$$('.bn').forEach(b=>b.addEventListener('click', ()=>setActiveTab(b.dataset.tab)));

/* settings wiring */
$('#tmdbKey').value = state.tmdbKey;
$('#tmdbKey').addEventListener('change', e=>{
  state.tmdbKey = e.target.value.trim();
  ls.set(KEY_TM, state.tmdbKey);
  refreshAll();
});

/* plugins UI */
function renderInstalledPlugins(){
  const wrap = $('#installedPlugins'); wrap.innerHTML='';
  if(!state.plugins.length){ wrap.innerHTML='<div class="small muted">No plugins installed</div>'; return; }
  state.plugins.forEach((p, idx)=>{
    const el = document.createElement('div'); el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='space-between';
    el.style.padding='8px'; el.style.marginBottom='8px'; el.style.background='var(--card)'; el.style.borderRadius='10px';
    el.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${p.image || ''}" style="width:42px;height:42px;border-radius:8px;object-fit:cover" onerror="this.style.display='none'"/>
        <div>
          <div style="font-weight:700">${escapeHtml(p.name||'Unnamed')}</div>
          <div class="small muted">${escapeHtml(p.stream_type||'')}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" data-idx="${idx}" data-act="toggle">${p.enabled? 'Disable':'Enable'}</button>
        <button class="btn ghost" data-idx="${idx}" data-act="remove">Remove</button>
      </div>
    `;
    wrap.appendChild(el);
  });
  wrap.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ev=>{
      const i = Number(btn.dataset.idx);
      const act = btn.dataset.act;
      if(act==='remove'){ state.plugins.splice(i,1); persistPlugins(); renderInstalledPlugins(); }
      if(act==='toggle'){ state.plugins[i].enabled = !state.plugins[i].enabled; persistPlugins(); renderInstalledPlugins(); }
    });
  });
}

function persistPlugins(){ ls.set(KEY_PLUGS, state.plugins); }

/* add plugin */
$('#pasteExample').addEventListener('click', ()=>{
  const ex = {
    name: "ExamplePlugin",
    image: "https://via.placeholder.com/300x300.png?text=Plugin",
    embed_url: "https://example.com/embed/{t}/{i}",
    tv_embed_url: "https://example.com/embed/{t}/{i}/{s}/{e}",
    stream_type: "api"
  };
  $('#pluginInput').value = JSON.stringify(ex, null, 2);
});

$('#addPlugin').addEventListener('click', ()=>{
  $('#pluginErrors').textContent = '';
  let text = $('#pluginInput').value.trim();
  if(!text){ $('#pluginErrors').textContent = 'Paste plugin JSON first.'; return; }
  let parsed;
  try{ parsed = JSON.parse(text); }
  catch(e){ $('#pluginErrors').textContent = 'Invalid JSON: '+e.message; return; }
  const err = pluginRequired(parsed);
  if(err){ $('#pluginErrors').textContent = err; return; }
  parsed.enabled = true;
  state.plugins.push(parsed);
  persistPlugins();
  $('#pluginInput').value = '';
  renderInstalledPlugins();
});

/* encode plugin to .merlmovieplugin (base64 string) */
$('#encodePlugin').addEventListener('click', ()=>{
  try{
    const t = $('#pluginInput').value.trim();
    if(!t) { $('#pluginErrors').textContent='Paste plugin JSON to encode.'; return; }
    JSON.parse(t); // validate
    const encoded = btoa(unescape(encodeURIComponent(t)));
    // produce downloadable file link
    const blob = new Blob([encoded], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='plugin.merlmovieplugin'; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }catch(err){ $('#pluginErrors').textContent = 'Invalid JSON: '+err.message; }
});

/* export/clear state */
$('#exportState').addEventListener('click', ()=>{
  const to = {tmdbKey: state.tmdbKey, plugins: state.plugins, recent: state.recent, favs: state.favs};
  const blob = new Blob([JSON.stringify(to,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='streamlite-state.json'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
});
$('#clearState').addEventListener('click', ()=>{
  if(!confirm('Clear all local data?')) return;
  ls.del(KEY_TM); ls.del(KEY_PLUGS); ls.del(KEY_RECENT); ls.del(KEY_FAVS);
  state = {tmdbKey:'',plugins:[],recent:[],favs:[]};
  $('#tmdbKey').value = '';
  renderInstalledPlugins(); renderFavourites();
  refreshAll();
});

/* debug */
function debugDump(){
  $('#debug').textContent = JSON.stringify({
    tmdbKey: !!state.tmdbKey,
    plugins: state.plugins.map(p=>({name:p.name,enabled:!!p.enabled})),
    recent: state.recent.slice(0,5),
    favs: state.favs.slice(0,5)
  }, null, 2);
}

/* --- TMDb fetching --- */
async function fetchPopular(type='movie', page=1){
  if(!state.tmdbKey) return {results:[],error:'no_key'};
  const url = `${TM_BASE}/${type}/popular?api_key=${encodeURIComponent(state.tmdbKey)}&language=en-US&page=${page}`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('TMDb error '+r.status);
    return await r.json();
  }catch(e){
    return {results:[],error:e.message};
  }
}

async function searchTmdb(type='movie', query='', page=1){
  if(!state.tmdbKey) return {results:[],error:'no_key'};
  const url = `${TM_BASE}/search/${type}?api_key=${encodeURIComponent(state.tmdbKey)}&language=en-US&query=${encodeURIComponent(query)}&page=${page}&include_adult=false`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('TMDb error '+r.status);
    return await r.json();
  }catch(e){ return {results:[],error:e.message}; }
}

/* --- render grid --- */
function clearGrid(sel){ $(sel).innerHTML=''; }
function makeCard(item, type='movie'){
  const poster = item.poster_path ? tmImg(item.poster_path,'w342') : '';
  const el = document.createElement('div'); el.className='card';
  el.innerHTML = `<img src="${poster}" alt="${escapeHtml(item.title || item.name || '')}" loading="lazy"/>
    <div class="meta"><h3>${escapeHtml(item.title || item.name || 'Untitled')}</h3><p class="muted">${escapeHtml((item.release_date||item.first_air_date||'').slice(0,4))} · ${escapeHtml(type)}</p></div>`;
  el.addEventListener('click', ()=>openModalFor(item, type));
  return el;
}

async function loadPopularMovies(){
  $('#moviesInfo').textContent = '';
  const res = await fetchPopular('movie',1);
  if(res.error){ $('#moviesInfo').textContent = res.error; return; }
  const grid = $('#moviesGrid'); grid.innerHTML='';
  (res.results||[]).slice(0,20).forEach(m=>grid.appendChild(makeCard(m,'movie')));
}

async function loadPopularTv(){
  $('#tvInfo').textContent = '';
  const res = await fetchPopular('tv',1);
  if(res.error){ $('#tvInfo').textContent = res.error; return; }
  const grid = $('#tvGrid'); grid.innerHTML='';
  (res.results||[]).slice(0,20).forEach(m=>grid.appendChild(makeCard(m,'tv')));
}

/* search handlers */
$('#moviesSearchBtn').addEventListener('click', async ()=>{
  const q = $('#moviesSearch').value.trim();
  if(!q){ loadPopularMovies(); return; }
  const res = await searchTmdb('movie', q);
  $('#moviesInfo').textContent = res.error ? res.error : `results: ${res.total_results||0}`;
  const grid = $('#moviesGrid'); grid.innerHTML='';
  (res.results||[]).slice(0,40).forEach(m=>grid.appendChild(makeCard(m,'movie')));
});

$('#tvSearchBtn').addEventListener('click', async ()=>{
  const q = $('#tvSearch').value.trim();
  if(!q){ loadPopularTv(); return; }
  const res = await searchTmdb('tv', q);
  $('#tvInfo').textContent = res.error ? res.error : `results: ${res.total_results||0}`;
  const grid = $('#tvGrid'); grid.innerHTML='';
  (res.results||[]).slice(0,40).forEach(m=>grid.appendChild(makeCard(m,'tv')));
});

/* modal (details + "play") */
const modal = $('#modal');
const modalBody = $('#modalBody');
const modalTitle = $('#modalTitle');
const starBtn = $('#starBtn');

function openModalFor(item, type='movie'){
  modal.classList.add('show');
  modalTitle.textContent = (item.title || item.name || 'Untitled');
  // show basic metadata and plugin options
  const html = [];
  if(item.overview) html.push(`<div class="small muted">${escapeHtml(item.overview)}</div>`);
  html.push(`<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">`);
  // plugin actions (for each enabled plugin)
  const enabled = state.plugins.filter(p=>p.enabled);
  if(enabled.length===0){
    html.push(`<div class="small muted">No plugins installed. Add in Settings to enable playback (MerlMovie plugin format supported).</div>`);
  } else {
    enabled.forEach((p, idx)=>{
      // build embed url: choose tv_embed_url for tv or embed_url for movie
      const template = (type === 'tv' ? (p.tv_embed_url || p.embed_url) : p.embed_url || p.tv_embed_url);
      if(!template) {
        html.push(`<div class="chip">${escapeHtml(p.name)} — no template for ${escapeHtml(type)}</div>`);
      } else {
        // replace placeholders where possible. We don't have tmdb id mapping to plugin ids by default,
        // so show the filled-in URL template with tmdb id placeholder {i} => tmdb id.
        const filled = template.replace('{t}', type).replace('{i}', item.id || '').replace('{s}','1').replace('{e}','1');
        html.push(`<div style="min-width:240px">
                    <div style="display:flex;gap:8px;align-items:center">
                      <img src="${p.image||''}" style="width:44px;height:44px;border-radius:8px;object-fit:cover" onerror="this.style.display='none'"/>
                      <div style="flex:1">
                        <div style="font-weight:700">${escapeHtml(p.name)}</div>
                        <div class="small muted">${escapeHtml(p.stream_type)}</div>
                      </div>
                      <button class="btn" data-idx="${idx}" data-action="open">Open</button>
                    </div>
                    <div class="small muted" style="margin-top:6px;word-break:break-all">${escapeHtml(filled)}</div>
                  </div>`);
      }
    });
  }
  html.push('</div>');
  html.push(`<div style="margin-top:12px"><button id="playLocal" class="btn ghost">Play sample (demo player)</button></div>`);
  modalBody.innerHTML = html.join('');
  // wire plugin open buttons
  modalBody.querySelectorAll('button[data-action="open"]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const idx = Number(b.dataset.idx);
      const p = state.plugins.filter(x=>x.enabled)[idx];
      if(!p) return alert('Plugin missing');
      const template = (type === 'tv' ? (p.tv_embed_url || p.embed_url) : p.embed_url || p.tv_embed_url);
      const url = template.replace('{t}', type).replace('{i}', item.id || '').replace('{s}','1').replace('{e}','1');
      // For stream_type api -> we fetch the JSON and show qualities
      if(p.stream_type === 'api'){
        openStreamApi(url, p);
      } else {
        // webview -> open the url in new tab
        window.open(url, '_blank', 'noopener');
      }
    });
  });
  modalBody.querySelector('#playLocal')?.addEventListener('click', ()=>openDemoPlayer(item));
  // star button state
  starBtn.textContent = (state.favs.find(f=>f.id===item.id && f.type===type) ? '★ Unstar' : '☆ Star');
  starBtn.onclick = ()=>toggleFav(item, type);
}

$('#closeModal').addEventListener('click', ()=>{ modal.classList.remove('show'); modalBody.innerHTML=''; });

function openStreamApi(apiUrl, plugin){
  // show loader
  modalBody.innerHTML = `<div class="small muted">Fetching stream data...</div>`;
  fetch(apiUrl)
    .then(r=>r.json())
    .then(j=>{
      const qualities = j.qualities || [];
      const subs = j.subtitles || [];
      let html = `<div style="display:flex;flex-direction:column;gap:8px">`;
      if(qualities.length===0) html += `<div class="small muted">No qualities returned by plugin response.</div>`;
      qualities.forEach(q=>{
        html += `<div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                  <div>${escapeHtml(q.name||'')}</div>
                  <div><button class="btn" data-src="${escapeHtml(q.link)}">Play</button></div>
                 </div>`;
      });
      if(subs.length) {
        html += `<div class="small muted">Subtitles available:</div>`;
        subs.forEach(s=> html += `<div class="chip">${escapeHtml(s.name)} — <small class="small muted">${escapeHtml(s.link)}</small></div>`);
      }
      html += `</div>`;
      modalBody.innerHTML = html;
      modalBody.querySelectorAll('button[data-src]').forEach(b=>{
        b.addEventListener('click', ()=>playUrl(b.dataset.src));
      });
    })
    .catch(e=>{
      modalBody.innerHTML = `<div class="small muted">Failed to fetch plugin response: ${escapeHtml(e.message||'')}</div>`;
    });
}

function openDemoPlayer(item){
  // show a simple HTML5 player demo (for mp4/hls demo links user might provide)
  modalBody.innerHTML = `<div style="background:#000;border-radius:10px;padding:8px"><video id="demoVid" controls style="width:100%;border-radius:8px"></video></div>
    <div style="margin-top:8px" class="small muted">This is a demo player. Use plugins (Settings) to provide real stream URLs.</div>`;
  // load a small sample mp4 from demo CDN if available (CORS permitting) - else keep empty
  const demoMp4 = 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4';
  const v = modalBody.querySelector('#demoVid');
  v.src = demoMp4;
  v.play().catch(()=>{/* autoplay blocked */});
}

/* play URL (open in new tab with safe handling or attach to video when same origin) */
function playUrl(url){
  // If it's an mp4/HLS, we try to open in a new tab; a more advanced host could embed hls.js
  window.open(url, '_blank', 'noopener');
}

/* favourites & recent */
function toggleFav(item, type='movie'){
  const key = {id:item.id, title:item.title||item.name, poster:item.poster_path, type};
  const existing = state.favs.find(f=>f.id===item.id && f.type===type);
  if(existing){
    state.favs = state.favs.filter(f=>!(f.id===item.id && f.type===type));
  } else {
    state.favs.unshift(key);
    if(state.favs.length>200) state.favs.pop();
  }
  ls.set(KEY_FAVS, state.favs);
  starBtn.textContent = (existing? '☆ Star' : '★ Unstar');
  renderFavourites();
}

function addRecent(item, type='movie'){
  const entry = {id:item.id, title:item.title||item.name, poster:item.poster_path, type, at:Date.now()};
  // dedupe
  state.recent = state.recent.filter(r=>!(r.id===entry.id && r.type===entry.type));
  state.recent.unshift(entry);
  if(state.recent.length>100) state.recent.pop();
  ls.set(KEY_RECENT, state.recent);
  renderFavourites();
}

function renderFavourites(){
  const recentWrap = $('#recentList'); recentWrap.innerHTML='';
  const favWrap = $('#favList'); favWrap.innerHTML='';
  (state.recent||[]).slice(0,20).forEach(r=>{
    const el = document.createElement('div'); el.className='hcard';
    el.innerHTML = `<img src="${r.poster?tmImg(r.poster,'w342') : ''}" alt="${escapeHtml(r.title)}"/><div style="padding:6px"><div style="font-size:13px;font-weight:700">${escapeHtml(r.title)}</div><div class="small muted">${escapeHtml(r.type)}</div></div>`;
    el.addEventListener('click', ()=>openModalFor({id:r.id, title:r.title, poster_path:r.poster}, r.type));
    recentWrap.appendChild(el);
  });
  (state.favs||[]).slice(0,20).forEach(r=>{
    const el = document.createElement('div'); el.className='hcard';
    el.innerHTML = `<img src="${r.poster?tmImg(r.poster,'w342') : ''}" alt="${escapeHtml(r.title)}"/><div style="padding:6px"><div style="font-size:13px;font-weight:700">${escapeHtml(r.title)}</div><div class="small muted">${escapeHtml(r.type)}</div></div>`;
    el.addEventListener('click', ()=>openModalFor({id:r.id, title:r.title, poster_path:r.poster}, r.type));
    favWrap.appendChild(el);
  });
}

/* helper escape */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

/* --- Initialization --- */
function refreshAll(){
  debugDump();
  renderInstalledPlugins();
  renderFavourites();
  loadPopularMovies();
  loadPopularTv();
}
renderInstalledPlugins();
renderFavourites();
refreshAll();
debugDump();

/* persist on unload */
window.addEventListener('beforeunload', ()=>{ ls.set(KEY_PLUGS, state.plugins); ls.set(KEY_RECENT, state.recent); ls.set(KEY_FAVS, state.favs); });

/* Some quick interactions: when modal opens, add to recent (simulate) */
document.getElementById('modal').addEventListener('transitionend', ()=>{
  // not needed
});

/* When a user clicks a card we already call openModalFor and we add to recent on "play" or open plugin.
   For demonstration, also add to recent when modal opened */
const origOpen = openModalFor;
openModalFor = function(item, type){ origOpen(item,type); addRecent(item,type); };

})();
</script>
</body>
</html>
